<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¨…å‹™åœ°åœ– - 2025/26 å¹´åº¦</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Firebase SDK (ç”¨æ–¼å„²å­˜å®¢äººè³‡æ–™) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ç’°å¢ƒè®Šæ•¸ (ç”±ç³»çµ±æä¾›)
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'tax-map-agent-pro';

        // åŒ¿åç™»å…¥ä»¥ç¢ºä¿èƒ½å¯«å…¥è³‡æ–™åº«
        const initAuth = async () => {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Auth failed:", error);
            }
        };
        initAuth();

        window.db = db;
        window.appId = appId;
        window.auth = auth;
    </script>
    <style>
        body {
            font-family: 'Inter', "Microsoft JhengHei", sans-serif;
            background-color: #0a0a0a; 
            overflow: hidden;
            margin: 0;
            padding: 0;
            height: 100dvh; 
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: pan-y;
        }
        #app {
            width: 100%;
            height: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .card-bg {
            background-color: #121212; 
            position: relative;
            overflow: hidden;
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            user-select: none;
            -webkit-user-select: none;
        }
        #content-area {
            flex-grow: 1;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
            z-index: 20;
        }
        .map-grid {
            position: absolute;
            inset: 0;
            background-image: 
                linear-gradient(to right, rgba(59, 130, 246, 0.05) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(59, 130, 246, 0.05) 1px, transparent 1px);
            background-size: 30px 30px;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }
        .accent-orange { color: #ff6b00; }
        .bg-accent-orange { background-color: #ff6b00; }
        .accent-blue { color: #3b82f6; }
        .bg-accent-blue { background-color: #3b82f6; }
        .text-gray-custom { color: #a1a1aa; }
        .border-gray-custom { border-color: #333; }
        input::placeholder { color: #4b5563; }
        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23ff6b00'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5em 1.5em;
        }
        input, select {
            user-select: auto;
            -webkit-user-select: auto;
        }
        .page-transition { transition: all 0.4s ease-in-out; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        @keyframes pulse-pin {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pin { animation: pulse-pin 2s infinite ease-in-out; }
        @keyframes swipe-hint {
            0% { transform: translateX(0); opacity: 0.5; }
            50% { transform: translateX(10px); opacity: 1; }
            100% { transform: translateX(0); opacity: 0.5; }
        }
        .animate-swipe { animation: swipe-hint 1.5s infinite ease-in-out; }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        .nav-btn {
            font-size: 10px;
            font-weight: 900;
            font-style: italic;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            padding: 8px 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: #a1a1aa;
            transition: all 0.2s;
            border-radius: 2px;
        }
        .nav-btn:active {
            background: rgba(255, 255, 255, 0.1);
            scale: 0.95;
            color: #fff;
            border-color: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>

    <div id="app">
        <div class="card-bg text-white shadow-[0_0_50px_rgba(0,0,0,0.8)] border-t border-white/5 relative">
            <div id="grid-bg" class="map-grid"></div>

            <div class="h-1.5 w-full bg-gray-800 flex relative z-10 shrink-0">
                <div id="progress-bar" class="h-full bg-accent-orange transition-all duration-500" style="width: 25%;"></div>
            </div>

            <div id="content-area" class="p-6 md:p-10 flex flex-col justify-between">
                <div class="h-full flex-grow flex flex-col justify-center">
                    
                    <!-- Page 01: Cover -->
                    <div id="page-01" class="relative flex flex-col items-center justify-center animate-fade-in text-center h-full">
                        <header class="relative flex flex-col items-center w-full">
                            <p class="text-sm md:text-base font-black italic accent-orange tracking-[0.5em] mb-6">2025/26 èª²ç¨…å¹´åº¦</p>
                            <div class="relative flex justify-center w-full mb-4">
                                <h1 class="font-black italic tracking-tighter uppercase relative z-10 flex flex-col text-left">
                                    <span class="text-7xl md:text-8xl relative z-20 drop-shadow-xl">TAX</span>
                                    <span class="text-7xl md:text-8xl accent-orange relative z-10 -mt-6 md:-mt-8 ml-16 md:ml-24 pr-2 inline-block">
                                        <span class="absolute -left-10 md:-left-12 top-8 md:top-10 animate-pin pointer-events-none">
                                            <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M12 21C16 17 20 13.4183 20 9C20 4.58172 16.4183 1 12 1C7.58172 1 4 4.58172 4 9C4 13.4183 8 17 12 21Z" fill="#3b82f6" stroke="white" stroke-width="2"/>
                                                <circle cx="12" cy="9" r="3" fill="white"/>
                                            </svg>
                                        </span>
                                        MAP
                                    </span>
                                </h1>
                            </div>
                            <h2 class="text-4xl md:text-5xl font-black italic tracking-tighter mt-8 flex items-center justify-center">ç¨…å‹™åœ°åœ–<span class="accent-orange">.</span></h2>
                            <p class="mt-10 text-base md:text-lg font-bold tracking-widest text-gray-custom uppercase leading-relaxed text-center mb-12">ç¾è¡Œå¹´åº¦å°èˆªï¼š<br>å…¨é¢æŒæ¡å…ç¨…é¡åŠæ‰£ç¨…æ”»ç•¥</p>
                            <button onclick="nextPage()" class="bg-accent-orange text-black font-black italic px-12 py-4 uppercase tracking-tighter text-xl rounded-sm hover:bg-orange-500 transition-all active:scale-95 z-30 shadow-lg shadow-orange-500/20">é–‹å§‹å°èˆª</button>
                        </header>
                        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-48 h-48 bg-blue-600/10 blur-[60px] rounded-full pointer-events-none"></div>
                        <div class="absolute bottom-2 left-0 w-full flex justify-center opacity-50 pointer-events-none">
                             <div class="flex gap-2 items-center text-xs md:text-sm font-black tracking-widest text-gray-custom uppercase">
                                 <svg class="animate-swipe" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14m-7-7l7 7-7 7"></path></svg>
                                 SWIPE OR DOUBLE TAP RIGHT
                             </div>
                        </div>
                    </div>

                    <!-- Page 02: Allowances -->
                    <div id="page-02" class="hidden text-left h-full flex flex-col justify-between">
                        <div>
                            <header class="mb-6"><p class="text-[10px] font-black italic accent-orange tracking-[0.3em] mb-1">02 / ALLOWANCES</p><h1 class="text-4xl md:text-5xl font-black italic tracking-tighter">å…ç¨…é¡åœ°åœ–<span class="accent-orange">.</span></h1></header>
                            <div class="space-y-6 relative z-30 pointer-events-none">
                                <div>
                                    <p class="text-[10px] font-bold accent-orange tracking-widest uppercase mb-3 border-b border-orange-900/50 pb-1">ç¾è¡Œå…ç¨…é¡ä¸€è¦½</p>
                                    <div class="grid grid-cols-1 gap-3">
                                        <div class="flex justify-between items-center"><span class="text-sm font-black italic">åŸºæœ¬å…ç¨…é¡</span><span class="text-lg font-black">$132,000</span></div>
                                        <div class="flex justify-between items-center"><span class="text-sm font-black italic">å­å¥³å…ç¨…é¡</span><span class="text-lg font-black">$130,000</span></div>
                                        <div class="flex justify-between items-center"><span class="text-sm font-black italic">çˆ¶æ¯åŒä½ (60+)</span><span class="text-lg font-black">$100,000</span></div>
                                    </div>
                                </div>
                                <div class="mt-6">
                                    <p class="text-[10px] font-bold accent-orange tracking-widest uppercase mb-3 border-b border-orange-900/50 pb-1">Deductions æ‰£é™¤é¡</p>
                                    <div class="grid grid-cols-1 gap-3">
                                        <div class="flex justify-between items-center"><span class="text-sm font-black italic">å±…æ‰€è²¸æ¬¾ / ç§Ÿé‡‘æ‰£é™¤</span><span class="text-lg font-black">$100,000</span></div>
                                        <div class="flex justify-between items-center"><span class="text-sm font-black italic text-gray-300">è‡ªé¡˜é†«ä¿ (VHIS)</span><span class="text-lg font-black text-gray-300">$8,000</span></div>
                                        <div class="flex justify-between items-center"><span class="text-sm font-black italic accent-orange">å¹´é‡‘ (QDAP) / TVC</span><span class="text-lg font-black accent-orange">$60,000</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-between mt-8 relative z-40">
                            <button onclick="prevPage()" class="nav-btn">PREVIOUS</button>
                            <button onclick="nextPage()" class="nav-btn">NEXT</button>
                        </div>
                    </div>

                    <!-- Page 03: Calculator -->
                    <div id="page-03" class="hidden h-full flex flex-col justify-between">
                        <div>
                            <header class="mb-4"><p class="text-[10px] font-black italic accent-orange tracking-[0.3em] mb-1">03 / PRO ENGINE</p><h1 class="text-3xl md:text-4xl font-black italic tracking-tighter">å°ˆæ¥­ç¨…å‹™è¨ˆç®—æ©Ÿ<span class="accent-orange">.</span></h1></header>
                            <div class="space-y-3 pb-4 relative z-40 custom-scroll">
                                <div class="p-3 bg-white/5 border border-gray-700 rounded-sm">
                                    <div class="grid grid-cols-2 gap-3">
                                        <div class="col-span-2"><label class="text-[10px] font-bold text-gray-custom uppercase mb-1 block">Annual Income ç¸½å¹´å…¥æ¯</label><input type="number" id="income" placeholder="600000" class="w-full bg-black/60 border border-gray-600 p-2.5 rounded-sm text-lg font-black focus:border-orange-500 outline-none text-white"></div>
                                        <div><label class="text-[10px] font-bold text-gray-custom uppercase mb-1 block">å©šå§»ç‹€æ³</label><select id="calcMarital" class="w-full bg-black/60 border border-gray-600 p-2.5 rounded-sm font-bold text-xs outline-none text-white"><option value="single">å–®èº«</option><option value="married">å·²å©š</option></select></div>
                                        <div><label class="text-[10px] font-bold text-gray-custom uppercase mb-1 block">å–®è¦ªå…ç¨…é¡</label><select id="singleParent" class="w-full bg-black/60 border border-gray-600 p-2.5 rounded-sm font-bold text-xs outline-none text-white"><option value="0">å¦</option><option value="1">æ˜¯</option></select></div>
                                    </div>
                                </div>
                                <details class="group bg-white/5 border border-gray-800 rounded-sm"><summary class="p-3 cursor-pointer flex justify-between items-center font-bold text-[11px] accent-orange tracking-widest outline-none">â–¼ å­å¥³/çˆ¶æ¯å…ç¨…é¡</summary><div class="p-3 pt-0 border-t border-gray-800 mt-2 grid grid-cols-2 gap-2"><div><label class="text-[9px] font-bold text-gray-400 block">å­å¥³ ($130k)</label><input type="number" id="childCount" value="0" class="w-full bg-black/40 border border-gray-700 p-2 rounded-sm font-bold text-sm"></div><div><label class="text-[9px] font-bold text-gray-400 block">çˆ¶æ¯60+ (åŒä½)</label><input type="number" id="p60T" value="0" class="w-full bg-black/40 border border-gray-700 p-2 rounded-sm font-bold text-sm"></div></div></details>
                                <details class="group bg-white/5 border border-gray-800 rounded-sm" open><summary class="p-3 cursor-pointer flex justify-between items-center font-bold text-[11px] accent-orange tracking-widest outline-none">â–¼ æ‰£ç¨…é …ç›®</summary><div class="p-3 pt-0 border-t border-gray-800 mt-2 space-y-2"><div class="flex justify-between items-center"><label class="text-[10px] font-bold text-gray-custom uppercase">å¼·ç©é‡‘ MPF</label><input type="number" id="mpf" value="18000" class="w-24 bg-black/60 border border-gray-700 p-1.5 rounded-sm text-right font-bold"></div><div class="flex justify-between items-center"><label class="text-[10px] font-bold text-gray-custom uppercase">å»¶æœŸå¹´é‡‘/TVC</label><input type="number" id="qdap" value="0" class="w-24 bg-black/60 border border-gray-700 p-1.5 rounded-sm text-right font-bold"></div><div class="flex justify-between items-center"><label class="text-[10px] font-bold text-gray-custom uppercase">è‡ªé¡˜é†«ä¿ VHIS</label><input type="number" id="vhis" value="0" class="w-24 bg-black/60 border border-gray-700 p-1.5 rounded-sm text-right font-bold"></div></div></details>
                                <button onclick="calculateProTax()" class="w-full bg-accent-orange py-3.5 mt-2 font-black italic text-lg hover:bg-orange-600 transition-all uppercase tracking-tighter shadow-lg shadow-orange-500/20 rounded-sm active:scale-95">è¨ˆç®—çµæœ</button>
                                <div id="result-box" class="mt-4 p-4 bg-gradient-to-br from-white/10 to-transparent border border-orange-500/40 rounded-sm hidden relative overflow-hidden"><p class="text-[10px] font-bold text-gray-300 uppercase mb-1">Estimated Tax æ‡‰ç¹³ç¨…æ¬¾</p><p id="tax-result" class="text-4xl md:text-5xl font-black accent-orange italic">$0</p></div>
                                <div id="ai-tips-container" class="mt-3 hidden"><button onclick="generateAITips()" id="ai-btn" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 py-3 font-black italic text-sm rounded-sm flex items-center justify-center gap-2">âœ¨ é¡¯ç¤ºéš±è—æ…³ç¨…ä½</button><div id="ai-result-box" class="mt-2 p-3 bg-indigo-900/30 border border-indigo-500/30 rounded-sm hidden"><div id="ai-text" class="text-[11px] text-indigo-50 leading-relaxed font-medium"></div></div></div>
                            </div>
                        </div>
                        <div class="flex justify-between mt-4 relative z-40">
                            <button onclick="prevPage()" class="nav-btn">PREVIOUS</button>
                            <button onclick="nextPage()" class="nav-btn">NEXT</button>
                        </div>
                    </div>

                    <!-- Page 04: Call to Action -->
                    <div id="page-04" class="hidden">
                        <header class="mb-4"><p class="text-[10px] font-black italic accent-orange tracking-[0.3em] mb-1">04 / THE DESTINATION</p><h1 class="text-4xl md:text-5xl font-black italic tracking-tighter leading-tight">é ˜å–æŒ‡å—<span class="accent-orange">.</span></h1></header>
                        <div class="space-y-4 relative z-40">
                            <div class="bg-accent-blue/10 p-3 border-l-4 border-accent-blue rounded-sm">
                                <p class="text-[11px] text-gray-200 leading-relaxed">ç‚ºäº†ç™¼é€æœ€é©åˆæ‚¨çš„<b>ã€Œæ‰£ç¨…æ‡¶äººåŒ…ã€</b>ç‰ˆæœ¬ï¼Œè«‹é¸æ“‡æ‚¨çš„èº«åˆ†åŠå¡«å¯«è¯çµ¡è³‡æ–™ã€‚</p>
                            </div>

                            <div class="space-y-2 mt-4">
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="text" id="cta-name" placeholder="å§“å" class="w-full bg-black/60 border border-gray-600 p-3 rounded-sm text-sm font-bold focus:border-blue-500 outline-none text-white">
                                    <input type="tel" id="cta-phone" placeholder="WhatsApp è™Ÿç¢¼" class="w-full bg-black/60 border border-gray-600 p-3 rounded-sm text-sm font-bold focus:border-green-500 outline-none text-white">
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <select id="cta-marital" class="w-full bg-black/60 border border-gray-600 p-3 rounded-sm text-xs font-bold focus:border-blue-500 outline-none text-white">
                                        <option value="" disabled selected>å©šå§»ç‹€æ³</option>
                                        <option value="å–®èº«">å–®èº« / æœªå©š</option>
                                        <option value="å·²å©š">å·²å©š / åˆä½µè¨ˆç®—</option>
                                    </select>
                                    <select id="cta-profile" class="w-full bg-black/60 border border-gray-600 p-3 rounded-sm text-[10px] font-bold focus:border-orange-500 outline-none text-white">
                                        <option value="" disabled selected>é ˜å–æŒ‡å—ç‰ˆæœ¬</option>
                                        <option value="å°è³‡æ—/è·å ´æ–°äººç‰ˆ">å°è³‡æ— / è·å ´æ–°äººç‰ˆ</option>
                                        <option value="å®¶åº­æ”¯æŸ±/ä¸­ç”¢é€²éšç‰ˆ">å®¶åº­æ”¯æŸ± / ä¸­ç”¢é€²éšç‰ˆ</option>
                                        <option value="å°ˆæ¥­äººå£«/é«˜å…¥æ¯å„ªåŒ–ç‰ˆ">å°ˆæ¥­äººå£« / é«˜å…¥æ¯å„ªåŒ–ç‰ˆ</option>
                                    </select>
                                </div>
                                <button onclick="handleExcelRequest()" id="cta-btn" class="w-full bg-accent-blue py-4 mt-2 font-black italic text-lg hover:bg-blue-600 transition-all shadow-[0_0_20px_rgba(59,130,246,0.3)] uppercase tracking-tighter flex items-center justify-center gap-3 rounded-sm active:scale-95">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                    ç²å–å°ˆå±¬æ‡¶äººåŒ…
                                </button>
                                <p class="text-[9px] text-center text-gray-500 uppercase mt-2 italic leading-relaxed pointer-events-none">* æ‚¨çš„è³‡æ–™åƒ…ä¾›ç™¼é€è³‡è¨Šä¹‹ç”¨ã€‚å…§å®¹ä¸æ§‹æˆå°ˆæ¥­ç¨…å‹™å»ºè­°ã€‚</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <footer class="mt-auto border-t border-gray-custom flex justify-between items-center bg-black/40 px-6 py-3 shrink-0 pointer-events-none relative z-30">
                <div><p class="text-[9px] font-black tracking-[0.2em] italic uppercase">Tax Map</p><p class="text-[9px] font-bold text-gray-custom tracking-widest uppercase">By Klau</p></div>
                <div class="text-2xl font-black italic text-gray-400" id="page-number">01</div>
            </footer>
        </div>
    </div>

    <script type="module">
        import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let currentPage = 1;
        const totalPages = 4;
        const apiKey = ""; 
        let latestTaxData = null;

        window.updateUI = () => {
            for (let i = 1; i <= totalPages; i++) {
                const p = document.getElementById(`page-0${i}`);
                p.classList.add('hidden');
                p.classList.remove('animate-fade-in', 'flex', 'flex-col');
            }
            const activePage = document.getElementById(`page-0${currentPage}`);
            activePage.classList.remove('hidden');
            if (currentPage === 2 || currentPage === 3) activePage.classList.add('flex', 'flex-col');
            void activePage.offsetWidth;
            activePage.classList.add('animate-fade-in');
            document.getElementById('page-number').innerText = `0${currentPage}`;
            const progress = (currentPage / totalPages) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
        };

        window.nextPage = () => { if (currentPage < totalPages) { currentPage++; window.updateUI(); } };
        window.prevPage = () => { if (currentPage > 1) { currentPage--; window.updateUI(); } };

        window.handleExcelRequest = async () => {
            const btn = document.getElementById('cta-btn');
            const name = document.getElementById('cta-name').value;
            const phone = document.getElementById('cta-phone').value;
            const marital = document.getElementById('cta-marital').value;
            const profile = document.getElementById('cta-profile').value;
            
            if(!name || !phone || !marital || !profile) { 
                btn.innerHTML = "è«‹å¡«å¯«å®Œæ•´è³‡æ–™ï¼"; 
                setTimeout(()=>btn.innerHTML="ç²ç²å–å°ˆå±¬æ‡¶äººåŒ…", 2000);
                return; 
            }

            // ğŸ›‘ ä¿å­˜åˆ° Firebase æ•¸æ“šåº«
            try {
                if (window.auth.currentUser) {
                    const leadsRef = collection(window.db, 'artifacts', window.appId, 'public', 'data', 'leads');
                    await addDoc(leadsRef, {
                        name,
                        phone,
                        maritalStatus: marital,
                        chosenProfile: profile,
                        calculatorInput: latestTaxData || {}, // å®¢äººåœ¨è¨ˆç®—æ©Ÿå¡«çš„æ‰€æœ‰è³‡æ–™
                        timestamp: serverTimestamp()
                    });
                }
            } catch (e) {
                console.error("Error saving lead:", e);
            }
            
            const yourWhatsAppNumber = "85291234567"; 
            const message = `Hi Klauï¼Œæˆ‘ä¿‚ ${name} (${marital})ï¼Œæˆ‘æƒ³é ˜å–ã€${profile}ã€‘2025/26 æ‰£ç¨…æ‡¶äººåŒ…ï¼æˆ‘çš„è¯çµ¡é›»è©±æ˜¯ ${phone}ã€‚`;
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${yourWhatsAppNumber}?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
        };

        window.calculateProTax = () => {
            const income = parseFloat(document.getElementById('income').value) || 0;
            const isMarried = document.getElementById('calcMarital').value === 'married';
            const childCount = parseInt(document.getElementById('childCount').value) || 0;
            const p60T = parseInt(document.getElementById('p60T').value) || 0;
            const mpf = Math.min(parseFloat(document.getElementById('mpf').value) || 0, 18000);
            const qdap = Math.min(parseFloat(document.getElementById('qdap').value) || 0, 60000);
            const vhis = parseFloat(document.getElementById('vhis').value) || 0;

            let totalAllowance = isMarried ? 264000 : 132000;
            if (document.getElementById('singleParent').value === '1' && !isMarried) totalAllowance += 132000; 
            totalAllowance += (childCount * 130000);
            totalAllowance += (p60T * 100000);
            
            const totalDeductions = mpf + qdap + vhis;
            let nci = Math.max(0, income - totalAllowance - totalDeductions);
            let progTax = 0;
            if (nci > 200000) progTax = 16000 + (nci - 200000) * 0.17;
            else if (nci > 150000) progTax = 9000 + (nci - 150000) * 0.14;
            else if (nci > 100000) progTax = 4000 + (nci - 100000) * 0.10;
            else if (nci > 50000) progTax = 1000 + (nci - 50000) * 0.06;
            else if (nci > 0) progTax = nci * 0.02;

            let finalTax = Math.max(0, progTax - 3000);
            
            // ğŸ’¡ é€™è£¡æ˜¯é—œéµï¼šå„²å­˜ç•¶ä¸‹çš„æ‰€æœ‰æ•¸æ“šï¼Œä»¥ä¾¿ç¨å¾Œé€£åŒå€‹äººè³‡æ–™ä¸€èµ·å­˜æª”
            latestTaxData = { 
                income, 
                maritalInCalc: isMarried ? 'married' : 'single', 
                childCount, 
                p60T, 
                mpf, 
                qdap, 
                vhis, 
                calculatedTax: finalTax 
            };

            document.getElementById('result-box').classList.remove('hidden');
            document.getElementById('tax-result').innerText = `$${Math.round(finalTax).toLocaleString()}`;
            document.getElementById('ai-tips-container').classList.remove('hidden');
        };

        window.generateAITips = async () => {
            if (!latestTaxData) return;
            const btn = document.getElementById('ai-btn');
            const resultBox = document.getElementById('ai-result-box');
            const textBox = document.getElementById('ai-text');
            btn.innerHTML = "âœ¨ åˆ†æä¸­...";
            const promptText = `ä½ ä¿‚ç†è²¡é¡§å•åŠ©æ‰‹ã€‚å¹´è–ª$${latestTaxData.income}ï¼Œç¨…æ¬¾$${latestTaxData.calculatedTax}ã€‚QDAP$${latestTaxData.qdap}ï¼ŒVHIS$${latestTaxData.vhis}ã€‚ç”¨å»£æ±è©±å£èªå¯«80å­—çŸ­è©•ã€‚çµå°¾å«ä½¢ä¸‹ä¸€é æ”æ‡¶äººåŒ…ã€‚`;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
                });
                const data = await response.json();
                textBox.innerText = data.candidates?.[0]?.content?.parts?.[0]?.text || "æš«æ™‚æœªèƒ½åˆ†æã€‚";
                resultBox.classList.remove('hidden');
                btn.innerHTML = "âœ¨ åˆ†æå®Œæˆ";
            } catch { btn.innerHTML = "âœ¨ ç³»çµ±ç¹å¿™"; }
        };

        let touchStartX = 0;
        let touchEndX = 0;
        let lastTap = 0;
        const appElement = document.getElementById('app');

        appElement.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;
            const tapX = e.changedTouches[0].clientX;
            const width = window.innerWidth;
            if (tapLength < 300 && tapLength > 0) {
                if (tapX < width * 0.4) window.prevPage();
                else if (tapX > width * 0.6) window.nextPage();
                e.preventDefault();
            }
            lastTap = currentTime;
        }, { passive: false });

        appElement.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            const diffX = touchEndX - touchStartX;
            if (Math.abs(diffX) > 80) {
                if (diffX > 80) window.nextPage();
                else window.prevPage();
            }
        }, { passive: true });
    </script>
</body>
</html>
